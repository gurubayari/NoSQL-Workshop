AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::LanguageExtensions
Description: 'AWS NoSQL Workshop - Unicorn E-Commerce Infrastructure (Basic - API Gateway Only)'

Parameters:
  ProjectName:
    Type: String
    Default: 'unicorn-ecommerce'
  Environment:
    Type: String
    Default: 'dev'
    AllowedValues: ['dev', 'staging', 'prod']
  VpcCidr:
    Type: String
    Default: '10.0.0.0/16'
  LatestAmiId:
    Type: "AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>"
    Default: "/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-6.1-x86_64"

Resources:
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-vpc'
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-igw'

  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref VPC
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: '10.0.1.0/24'
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-public-subnet-1'

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: '10.0.2.0/24'
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-public-subnet-2'

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: '10.0.11.0/24'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-private-subnet-1'

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: '10.0.12.0/24'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-private-subnet-2'
  NatGateway1EIP:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc

  NatGateway1:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGateway1EIP.AllocationId
      SubnetId: !Ref PublicSubnet1

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-public-routes'

  DefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: '0.0.0.0/0'
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet1

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet2

  PrivateRouteTable1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-private-routes-1'

  DefaultPrivateRoute1:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      DestinationCidrBlock: '0.0.0.0/0'
      NatGatewayId: !Ref NatGateway1

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      SubnetId: !Ref PrivateSubnet1

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      SubnetId: !Ref PrivateSubnet2

  # Security Groups
  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${ProjectName}-${Environment}-lambda-sg'
      GroupDescription: Security group for Lambda functions
      VpcId: !Ref VPC
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: '0.0.0.0/0'

  DatabaseSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${ProjectName}-${Environment}-database-sg'
      GroupDescription: Security group for databases
      VpcId: !Ref VPC

  # Security Group Rules (separate to avoid circular dependencies)
  LambdaToDatabaseRule1:
    Type: AWS::EC2::SecurityGroupEgress
    Properties:
      GroupId: !Ref LambdaSecurityGroup
      IpProtocol: tcp
      FromPort: 27017
      ToPort: 27017
      DestinationSecurityGroupId: !Ref DatabaseSecurityGroup

  LambdaToDatabaseRule2:
    Type: AWS::EC2::SecurityGroupEgress
    Properties:
      GroupId: !Ref LambdaSecurityGroup
      IpProtocol: tcp
      FromPort: 6379
      ToPort: 6379
      DestinationSecurityGroupId: !Ref DatabaseSecurityGroup

  DatabaseFromLambdaRule1:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref DatabaseSecurityGroup
      IpProtocol: tcp
      FromPort: 27017
      ToPort: 27017
      SourceSecurityGroupId: !Ref LambdaSecurityGroup

  DatabaseFromLambdaRule2:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref DatabaseSecurityGroup
      IpProtocol: tcp
      FromPort: 6379
      ToPort: 6379
      SourceSecurityGroupId: !Ref LambdaSecurityGroup


  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-${Environment}-lambda-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                  - dynamodb:Scan
                  - dynamodb:BatchGetItem
                  - dynamodb:BatchWriteItem
                  - dynamodb:TransactWriteItems
                  - dynamodb:TransactGetItems
                Resource:
                  - !GetAtt UsersTable.Arn
                  - !GetAtt ShoppingCartTable.Arn
                  - !GetAtt InventoryTable.Arn
                  - !GetAtt OrdersTable.Arn
                  - !GetAtt ChatHistoryTable.Arn
                  - !GetAtt SearchAnalyticsTable.Arn
                  - !Sub '${UsersTable.Arn}/index/*'
                  - !Sub '${OrdersTable.Arn}/index/*'
                  - !Sub '${SearchAnalyticsTable.Arn}/index/*'
        - PolicyName: BedrockAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - bedrock:InvokeModel
                  - bedrock:InvokeModelWithResponseStream
                Resource: 
                  - !Sub 'arn:aws:bedrock:${AWS::Region}::foundation-model/anthropic.claude-3-sonnet-20240229-v1:0'
                  - !Sub 'arn:aws:bedrock:${AWS::Region}::foundation-model/amazon.titan-embed-text-v1'
        - PolicyName: CognitoAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - cognito-idp:AdminCreateUser
                  - cognito-idp:AdminSetUserPassword
                  - cognito-idp:AdminInitiateAuth
                  - cognito-idp:AdminGetUser
                  - cognito-idp:GetUser
                  - cognito-idp:InitiateAuth
                Resource: !GetAtt UserPool.Arn
        - PolicyName: SecretsManagerAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                  - secretsmanager:DescribeSecret
                Resource: !Ref DatabaseSecret

  Ec2HostInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-${Environment}-bastion-role'
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
        - arn:aws:iam::aws:policy/SecretsManagerReadWrite
        - arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess
        - arn:aws:iam::aws:policy/CloudFrontFullAccess
        - arn:aws:iam::aws:policy/AWSLambda_FullAccess
        - arn:aws:iam::aws:policy/AmazonS3FullAccess
      Policies:
        - PolicyName: IAMPassRoleAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - iam:PassRole
                Resource: !GetAtt LambdaExecutionRole.Arn
        - PolicyName: APIGatewayFullAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - apigateway:*
                Resource: '*'
  UsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-${Environment}-users'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
        - AttributeName: email
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: EmailIndex
          KeySchema:
            - AttributeName: email
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      
  ShoppingCartTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-${Environment}-shopping-cart'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
        - AttributeName: productId
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH
        - AttributeName: productId
          KeyType: RANGE
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  InventoryTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-${Environment}-inventory'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: productId
          AttributeType: S
      KeySchema:
        - AttributeName: productId
          KeyType: HASH

  OrdersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-${Environment}-orders'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: orderId
          AttributeType: S
        - AttributeName: userId
          AttributeType: S
        - AttributeName: orderDate
          AttributeType: S
      KeySchema:
        - AttributeName: orderId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: UserOrdersIndex
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
            - AttributeName: orderDate
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  ChatHistoryTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-${Environment}-chat-history'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: sessionId
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: N
      KeySchema:
        - AttributeName: sessionId
          KeyType: HASH
        - AttributeName: timestamp
          KeyType: RANGE
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  SearchAnalyticsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-${Environment}-search-analytics'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: searchId
          AttributeType: S
        - AttributeName: userId
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: N
        - AttributeName: searchTerm
          AttributeType: S
      KeySchema:
        - AttributeName: searchId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: UserSearchIndex
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
            - AttributeName: timestamp
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: SearchTermIndex
          KeySchema:
            - AttributeName: searchTerm
              KeyType: HASH
            - AttributeName: timestamp
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  WebsiteBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-${Environment}-website-${AWS::AccountId}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  CloudFrontOriginAccessControl:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: !Sub '${ProjectName}-${Environment}-oac'
        Description: !Sub 'OAC for ${ProjectName}-${Environment} S3 bucket'
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Origins:
          - Id: S3Origin
            DomainName: !GetAtt WebsiteBucket.RegionalDomainName
            S3OriginConfig:
              OriginAccessIdentity: ''
            OriginAccessControlId: !GetAtt CloudFrontOriginAccessControl.Id
        Enabled: true
        DefaultRootObject: index.html
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6  # Managed-CachingOptimized
          Compress: true
        PriceClass: PriceClass_100
        ViewerCertificate:
          CloudFrontDefaultCertificate: true

  WebsiteBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref WebsiteBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowCloudFrontServicePrincipal
            Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: s3:GetObject
            Resource: !Sub '${WebsiteBucket.Arn}/*'
            Condition:
              StringEquals:
                "AWS:SourceArn": !Sub "arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}"

  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub '${ProjectName}-${Environment}-users'
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: true
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: false
      AutoVerifiedAttributes:
        - email
      Schema:
        - Name: email
          AttributeDataType: String
          Required: true
          Mutable: true

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId: !Ref UserPool
      ClientName: !Sub '${ProjectName}-${Environment}-client'
      GenerateSecret: false
      ExplicitAuthFlows:
        - ALLOW_ADMIN_USER_PASSWORD_AUTH
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
        - ALLOW_USER_SRP_AUTH

  DocumentDBSubnetGroup:
    Type: AWS::DocDB::DBSubnetGroup
    Properties:
      DBSubnetGroupName: !Sub '${ProjectName}-${Environment}-docdb-subnet-group'
      DBSubnetGroupDescription: Subnet group for DocumentDB cluster
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2

  DatabaseSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub '${ProjectName}-${Environment}-database-credentials'
      Description: Database credentials for DocumentDB and ElastiCache
      GenerateSecretString:
        SecretStringTemplate: '{"docdb_username": "docdbadmin", "elasticache_username": "cacheadmin"}'
        GenerateStringKey: 'shared_password'
        PasswordLength: 32
        ExcludeCharacters: '"@/\'



  DocumentDBCluster:
    Type: AWS::DocDB::DBCluster
    Properties:
      DBClusterIdentifier: !Sub '${ProjectName}-${Environment}-docdb-cluster'
      MasterUsername: !Sub '{{resolve:secretsmanager:${DatabaseSecret}:SecretString:docdb_username}}'
      MasterUserPassword: !Sub '{{resolve:secretsmanager:${DatabaseSecret}:SecretString:shared_password}}'
      EngineVersion: '5.0.0'
      Port: 27017
      ServerlessV2ScalingConfiguration:
        MinCapacity: 0.5 # Minimum capacity in DocumentDB Capacity Units (DCUs)
        MaxCapacity: 16
      DBSubnetGroupName: !Ref DocumentDBSubnetGroup
      VpcSecurityGroupIds:
        - !Ref DatabaseSecurityGroup
      BackupRetentionPeriod: 7
      StorageEncrypted: true

  DocumentDBInstance:
    Type: AWS::DocDB::DBInstance
    Properties:
      DBInstanceIdentifier: !Sub '${ProjectName}-${Environment}-docdb-instance'
      DBClusterIdentifier: !Ref DocumentDBCluster
      DBInstanceClass: 'db.serverless'

  ElastiCacheSubnetGroup:
    Type: AWS::ElastiCache::SubnetGroup
    Properties:
      Description: Subnet group for ElastiCache cluster
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2

  ElastiCacheUserGroup:
    Type: AWS::ElastiCache::UserGroup
    Properties:
      UserGroupId: !Sub '${ProjectName}-${Environment}-cache-user-group'
      Engine: valkey
      UserIds:
        - !Ref ElastiCacheUser

  ElastiCacheUser:
    Type: AWS::ElastiCache::User
    Properties:
      UserId: !Sub '{{resolve:secretsmanager:${DatabaseSecret}:SecretString:elasticache_username}}'
      UserName: !Sub '{{resolve:secretsmanager:${DatabaseSecret}:SecretString:elasticache_username}}'
      Engine: valkey
      Passwords:
        - !Sub '{{resolve:secretsmanager:${DatabaseSecret}:SecretString:shared_password}}'
      AccessString: 'on ~* &* +@all'

  ElastiCacheServerlessCache:
    Type: AWS::ElastiCache::ServerlessCache
    DependsOn: 
      - ElastiCacheUserGroup
      - ElastiCacheUser
    Properties:
      ServerlessCacheName: !Sub '${ProjectName}-${Environment}-cache'
      Description: Valkey serverless cache for Unicorn E-Commerce
      Engine: valkey
      CacheUsageLimits:
        DataStorage:
          Maximum: 10
          Unit: GB
        ECPUPerSecond:
          Maximum: 5000
      SecurityGroupIds:
        - !Ref DatabaseSecurityGroup
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      UserGroupId: !Ref ElastiCacheUserGroup

  ApiGateway:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: !Sub '${ProjectName}-${Environment}-api'
      Description: API Gateway for Unicorn E-Commerce
      EndpointConfiguration:
        Types:
          - REGIONAL
      Policy:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: '*'
            Action: 'execute-api:Invoke'
            Resource: '*'

  # Lambda Functions - Expanded from loop
  ProductApiFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-ProductApi'
      Description: 'ProductApi - Handles API operations'
      Runtime: python3.11
      Handler: lambda_function.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 30
      MemorySize: 256
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Environment:
        Variables:
          # Project Configuration
          PROJECT_NAME: !Ref ProjectName
          ENVIRONMENT: !Ref Environment
          # Database Configuration
          DOCUMENTDB_HOST: !GetAtt DocumentDBCluster.Endpoint
          DOCUMENTDB_PORT: '27017'
          ELASTICACHE_HOST: !GetAtt ElastiCacheServerlessCache.Endpoint.Address
          ELASTICACHE_PORT: '6379'
          USERS_TABLE: !Ref UsersTable
          INVENTORY_TABLE: !Ref InventoryTable
          USER_POOL_ID: !Ref UserPool
      Code:
        ZipFile: !Sub |
          import json
          def lambda_handler(event, context):
              return {
                  'statusCode': 200,
                  'body': json.dumps({'message': 'ProductApi function'}, indent=2)
              }

  ProductApiAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref ProductApiFunction
      FunctionVersion: $LATEST
      Name: LIVE
      ProvisionedConcurrencyConfig:
        ProvisionedConcurrencyUnits: 2

  CartApiFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-CartApi'
      Description: 'CartApi - Handles API operations'
      Runtime: python3.11
      Handler: lambda_function.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 30
      MemorySize: 256
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Environment:
        Variables:
          # Project Configuration
          PROJECT_NAME: !Ref ProjectName
          ENVIRONMENT: !Ref Environment
          # Database Configuration
          DOCUMENTDB_HOST: !GetAtt DocumentDBCluster.Endpoint
          DOCUMENTDB_PORT: '27017'
          ELASTICACHE_HOST: !GetAtt ElastiCacheServerlessCache.Endpoint.Address
          ELASTICACHE_PORT: '6379'
          USERS_TABLE: !Ref UsersTable          
          SHOPPING_CART_TABLE: !Ref ShoppingCartTable
          INVENTORY_TABLE: !Ref InventoryTable
          USER_POOL_ID: !Ref UserPool
      Code:
        ZipFile: !Sub |
          import json
          def lambda_handler(event, context):
              return {
                  'statusCode': 200,
                  'body': json.dumps({'message': 'CartApi function'}, indent=2)
              }

  CartApiAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref CartApiFunction
      FunctionVersion: $LATEST
      Name: LIVE
      ProvisionedConcurrencyConfig:
        ProvisionedConcurrencyUnits: 2

  OrderApiFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-OrderApi'
      Description: 'OrderApi - Handles API operations'
      Runtime: python3.11
      Handler: lambda_function.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 30
      MemorySize: 256
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Environment:
        Variables:
          # Project Configuration
          PROJECT_NAME: !Ref ProjectName
          ENVIRONMENT: !Ref Environment
          # Database Configuration
          DOCUMENTDB_HOST: !GetAtt DocumentDBCluster.Endpoint
          DOCUMENTDB_PORT: '27017'
          ELASTICACHE_HOST: !GetAtt ElastiCacheServerlessCache.Endpoint.Address
          ELASTICACHE_PORT: '6379'
          USERS_TABLE: !Ref UsersTable
          SHOPPING_CART_TABLE: !Ref ShoppingCartTable
          INVENTORY_TABLE: !Ref InventoryTable
          ORDERS_TABLE: !Ref OrdersTable
          USER_POOL_ID: !Ref UserPool
      Code:
        ZipFile: !Sub |
          import json
          def lambda_handler(event, context):
              return {
                  'statusCode': 200,
                  'body': json.dumps({'message': 'OrderApi function'}, indent=2)
              }

  OrderApiAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref OrderApiFunction
      FunctionVersion: $LATEST
      Name: LIVE
      ProvisionedConcurrencyConfig:
        ProvisionedConcurrencyUnits: 2

  AuthApiFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-AuthApi'
      Description: 'AuthApi - Handles API operations'
      Runtime: python3.11
      Handler: lambda_function.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 30
      MemorySize: 256
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Environment:
        Variables:
          # Project Configuration
          PROJECT_NAME: !Ref ProjectName
          ENVIRONMENT: !Ref Environment
          # Database Configuration
          DOCUMENTDB_HOST: !GetAtt DocumentDBCluster.Endpoint
          DOCUMENTDB_PORT: '27017'
          ELASTICACHE_HOST: !GetAtt ElastiCacheServerlessCache.Endpoint.Address
          ELASTICACHE_PORT: '6379'
          USERS_TABLE: !Ref UsersTable
          USER_POOL_ID: !Ref UserPool
      Code:
        ZipFile: !Sub |
          import json
          def lambda_handler(event, context):
              return {
                  'statusCode': 200,
                  'body': json.dumps({'message': 'AuthApi function'}, indent=2)
              }

  AuthApiAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref AuthApiFunction
      FunctionVersion: $LATEST
      Name: LIVE
      ProvisionedConcurrencyConfig:
        ProvisionedConcurrencyUnits: 2

  ReviewApiFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-ReviewApi'
      Description: 'ReviewApi - Handles API operations'
      Runtime: python3.11
      Handler: lambda_function.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 30
      MemorySize: 256
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Environment:
        Variables:
          # Project Configuration
          PROJECT_NAME: !Ref ProjectName
          ENVIRONMENT: !Ref Environment
          # Database Configuration
          DOCUMENTDB_HOST: !GetAtt DocumentDBCluster.Endpoint
          DOCUMENTDB_PORT: '27017'
          ELASTICACHE_HOST: !GetAtt ElastiCacheServerlessCache.Endpoint.Address
          ELASTICACHE_PORT: '6379'
          USERS_TABLE: !Ref UsersTable         
          USER_POOL_ID: !Ref UserPool
      Code:
        ZipFile: !Sub |
          import json
          def lambda_handler(event, context):
              return {
                  'statusCode': 200,
                  'body': json.dumps({'message': 'ReviewApi function'}, indent=2)
              }

  ReviewApiAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref ReviewApiFunction
      FunctionVersion: $LATEST
      Name: LIVE
      ProvisionedConcurrencyConfig:
        ProvisionedConcurrencyUnits: 2

  SearchApiFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-SearchApi'
      Description: 'SearchApi - Handles API operations'
      Runtime: python3.11
      Handler: lambda_function.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 30
      MemorySize: 256
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Environment:
        Variables:
          # Project Configuration
          PROJECT_NAME: !Ref ProjectName
          ENVIRONMENT: !Ref Environment
          # Database Configuration
          DOCUMENTDB_HOST: !GetAtt DocumentDBCluster.Endpoint
          DOCUMENTDB_PORT: '27017'
          ELASTICACHE_HOST: !GetAtt ElastiCacheServerlessCache.Endpoint.Address
          ELASTICACHE_PORT: '6379'
          USERS_TABLE: !Ref UsersTable
          ORDERS_TABLE: !Ref OrdersTable
          SEARCH_ANALYTICS_TABLE: !Ref SearchAnalyticsTable
          USER_POOL_ID: !Ref UserPool
      Code:
        ZipFile: !Sub |
          import json
          def lambda_handler(event, context):
              return {
                  'statusCode': 200,
                  'body': json.dumps({'message': 'SearchApi function'}, indent=2)
              }

  SearchApiAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref SearchApiFunction
      FunctionVersion: $LATEST
      Name: LIVE
      ProvisionedConcurrencyConfig:
        ProvisionedConcurrencyUnits: 2

  ChatApiFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-ChatApi'
      Description: 'ChatApi - Handles API operations'
      Runtime: python3.11
      Handler: lambda_function.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 30
      MemorySize: 256
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Environment:
        Variables:
          # Project Configuration
          PROJECT_NAME: !Ref ProjectName
          ENVIRONMENT: !Ref Environment
          # Database Configuration
          DOCUMENTDB_HOST: !GetAtt DocumentDBCluster.Endpoint
          DOCUMENTDB_PORT: '27017'
          ELASTICACHE_HOST: !GetAtt ElastiCacheServerlessCache.Endpoint.Address
          ELASTICACHE_PORT: '6379'
          USERS_TABLE: !Ref UsersTable
          INVENTORY_TABLE: !Ref InventoryTable
          ORDERS_TABLE: !Ref OrdersTable
          CHAT_HISTORY_TABLE: !Ref ChatHistoryTable
          SEARCH_ANALYTICS_TABLE: !Ref SearchAnalyticsTable
          USER_POOL_ID: !Ref UserPool
      Code:
        ZipFile: !Sub |
          import json
          def lambda_handler(event, context):
              return {
                  'statusCode': 200,
                  'body': json.dumps({'message': 'ChatApi function'}, indent=2)
              }

  ChatApiAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref ChatApiFunction
      FunctionVersion: $LATEST
      Name: LIVE
      ProvisionedConcurrencyConfig:
        ProvisionedConcurrencyUnits: 2

  AnalyticsApiFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-AnalyticsApi'
      Description: 'AnalyticsApi - Handles API operations'
      Runtime: python3.11
      Handler: lambda_function.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 30
      MemorySize: 256
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Environment:
        Variables:
          # Project Configuration
          PROJECT_NAME: !Ref ProjectName
          ENVIRONMENT: !Ref Environment
          # Database Configuration
          DOCUMENTDB_HOST: !GetAtt DocumentDBCluster.Endpoint
          DOCUMENTDB_PORT: '27017'
          ELASTICACHE_HOST: !GetAtt ElastiCacheServerlessCache.Endpoint.Address
          ELASTICACHE_PORT: '6379'
          USERS_TABLE: !Ref UsersTable
          SEARCH_ANALYTICS_TABLE: !Ref SearchAnalyticsTable
          USER_POOL_ID: !Ref UserPool
      Code:
        ZipFile: !Sub |
          import json
          def lambda_handler(event, context):
              return {
                  'statusCode': 200,
                  'body': json.dumps({'message': 'AnalyticsApi function'}, indent=2)
              }

  AnalyticsApiAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref AnalyticsApiFunction
      FunctionVersion: $LATEST
      Name: LIVE
      ProvisionedConcurrencyConfig:
        ProvisionedConcurrencyUnits: 2

  Ec2HostInstanceProfile:
    DependsOn: Ec2HostInstanceRole
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub '${ProjectName}-${Environment}-ec2-profile'
      Roles:
        - !Ref Ec2HostInstanceRole

  EC2HostInstance:
    Type: AWS::EC2::Instance
    DependsOn: 
      - ElastiCacheServerlessCache
      - DocumentDBInstance
      - ProductApiAlias
      - CartApiAlias
      - OrderApiAlias
      - AuthApiAlias
      - ReviewApiAlias
      - SearchApiAlias
      - ChatApiAlias
      - AnalyticsApiAlias
    CreationPolicy:
      ResourceSignal:
        Count: 1
        Timeout: PT10M
    Properties:
      ImageId: !Ref "LatestAmiId"
      InstanceType: m5.large
      IamInstanceProfile: !Ref Ec2HostInstanceProfile
      SubnetId: !Ref PublicSubnet1
      SecurityGroupIds:
        - !Ref Ec2SecurityGroup
        - !Ref LambdaSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-bastion-host'
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash

          function prerequisites {
            echo "updating dnf..."

            sudo dnf clean packages
            sudo dnf -q -y update

            # Install CloudFormation helper scripts
            sudo dnf install -q -y aws-cfn-bootstrap

            # SSM agent is pre-installed on AL2023, just ensure it's running
            sudo systemctl enable amazon-ssm-agent
            sudo systemctl start amazon-ssm-agent

            # Install additional packages
            sudo dnf -q -y install gcc python3 python3-pip unzip
            sudo dnf -q -y install wget git jq  

            # AWS CLI v2 is pre-installed on AL2023, but let's ensure it's latest
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip awscliv2.zip
            ./aws/install --update
            
            # Set up environment
            echo 'export AWS_DEFAULT_REGION=${AWS::Region}' >> /home/ec2-user/.bashrc
            echo 'export PROJECT_NAME=${ProjectName}' >> /home/ec2-user/.bashrc
            echo 'export ENVIRONMENT=${Environment}' >> /home/ec2-user/.bashrc

          }

          function setup_database_clients {
            echo "Setting up database clients..."
            
            # Ensure ec2-user home directory exists
            echo "Creating ec2-user home directory if needed..."
            sudo mkdir -p /home/ec2-user
            sudo chown ec2-user:ec2-user /home/ec2-user
            sudo chmod 755 /home/ec2-user
            
            # Install valkey-cli (Redis-compatible client)
            echo "Installing valkey-cli..."
            sudo dnf -q -y install valkey-cli
            
            # Install mongosh (MongoDB Shell)
            echo "Installing mongosh..."
            cat <<EOF | sudo tee /etc/yum.repos.d/mongodb-org-7.0.repo
[mongodb-org-7.0]
name=MongoDB Repository
baseurl=https://repo.mongodb.org/yum/amazon/2023/mongodb-org/7.0/x86_64/
gpgcheck=1
enabled=1
gpgkey=https://www.mongodb.org/static/pgp/server-7.0.asc
EOF
            
            sudo dnf -q -y install mongodb-mongosh
            
            # Download DocumentDB SSL certificate
            echo "Downloading DocumentDB SSL certificate..."
            wget -O /home/ec2-user/global-bundle.pem https://truststore.pki.rds.amazonaws.com/global/global-bundle.pem
            chown ec2-user:ec2-user /home/ec2-user/global-bundle.pem
            chmod 644 /home/ec2-user/global-bundle.pem
            
            # Get credentials from Secrets Manager
            echo "Retrieving database credentials..."
            SECRET_VALUE=$(aws secretsmanager get-secret-value --secret-id "${DatabaseSecret}" --region "${AWS::Region}" --query SecretString --output text)
            
            DOCDB_USERNAME=$(echo $SECRET_VALUE | jq -r '.docdb_username')
            ELASTICACHE_USERNAME=$(echo $SECRET_VALUE | jq -r '.elasticache_username')
            SHARED_PASSWORD=$(echo $SECRET_VALUE | jq -r '.shared_password')
            
            # URL encode the password for MongoDB connection string
            ENCODED_PASSWORD=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$SHARED_PASSWORD', safe=''))")
            
            # Create aliases for ec2-user
            echo "Creating database client aliases..."
            
            # Valkey/ElastiCache alias
            cat <<EOF >> /home/ec2-user/.bashrc

# Database client aliases - using safe functions
alias valkey='connect-valkey'
alias docdb='connect-docdb'

# Helper commands
alias get-db-creds='aws secretsmanager get-secret-value --secret-id "${DatabaseSecret}" --region "${AWS::Region}" --query SecretString --output text | jq .'

# Safe connection functions that handle special characters
connect-docdb() {
    local secret_value=\$(aws secretsmanager get-secret-value --secret-id "${DatabaseSecret}" --region "${AWS::Region}" --query SecretString --output text)
    local username=\$(echo "\$secret_value" | jq -r '.docdb_username')
    local password=\$(echo "\$secret_value" | jq -r '.shared_password')
    local encoded_password=\$(python3 -c "import urllib.parse; print(urllib.parse.quote('\$password', safe=''))")
    mongosh "mongodb://\$username:\$encoded_password@${DocumentDBCluster.Endpoint}:27017/?tls=true&tlsCAFile=~/global-bundle.pem&replicaSet=rs0&readPreference=secondaryPreferred&retryWrites=false"
}

connect-valkey() {
    local secret_value=\$(aws secretsmanager get-secret-value --secret-id "${DatabaseSecret}" --region "${AWS::Region}" --query SecretString --output text)
    local username=\$(echo "\$secret_value" | jq -r '.elasticache_username')
    local password=\$(echo "\$secret_value" | jq -r '.shared_password')
    valkey-cli -h ${ElastiCacheServerlessCache.Endpoint.Address} -p 6379 --user "\$username" --pass "\$password"
}
EOF

           
            
           
          }

          function deploy {

            sudo git clone https://github.com/gurubayari/NoSQL-Workshop.git /home/ec2-user/NoSQL-Workshop
            sudo chown -R ec2-user:ec2-user /home/ec2-user/NoSQL-Workshop

            cd /home/ec2-user/NoSQL-Workshop

            # Wait for resources to be ready
            echo "Waiting for resources to be ready..."
            
            echo "Deploying lambda functions"
            nohup sudo bash ./deploy-lambda-functions.sh "${ProjectName}" "${Environment}" "${AWS::Region}" > deploy-lambda-functions.log 2>&1 &
            
            echo "Setting up API Gateway resources and methods"
            nohup sudo bash ./setup-api-resources.sh "${ProjectName}" "${Environment}" "${AWS::Region}" > setup-api-resources.log 2>&1 &
          
            echo "Deploying front end application"
            nohup sudo bash ./deploy-frontend.sh "${ProjectName}" "${Environment}" "${AWS::Region}" "${WebsiteBucket}" "https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/${Environment}" "${UserPool}" "${UserPoolClient}" "${CloudFrontDistribution}" "${CloudFrontDistribution.DomainName}" > deploy-frontend.log 2>&1 &

            echo "Seeding data to databases"
            nohup sudo bash ./seed_data_to_databases.sh "${ProjectName}" "${Environment}" "${AWS::Region}" "${DatabaseSecret}" "${DocumentDBCluster.Endpoint}" "${ElastiCacheServerlessCache.Endpoint.Address}" > seed_data_to_databases.log 2>&1 &
          }

          function cfn_signal {
              # Signal CloudFormation that the instance is ready
              /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource EC2HostInstance --region ${AWS::Region}
          }
          
          prerequisites
          setup_database_clients
          deploy
          cfn_signal

  Ec2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${ProjectName}-${Environment}-bastion-sg'
      GroupDescription: Security group for bastion host - SSM access only
      VpcId: !Ref VPC
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: HTTP for package updates
        - IpProtocol: tcp
          FromPort: 53
          ToPort: 53
          CidrIp: 0.0.0.0/0
          Description: DNS resolution
        - IpProtocol: udp
          FromPort: 53
          ToPort: 53
          CidrIp: 0.0.0.0/0
          Description: DNS resolution
Outputs:
  CloudFrontURL:
    Description: CloudFront distribution URL
    Value: !Sub 'https://${CloudFrontDistribution.DomainName}'
  
  ApiGatewayId:
    Description: API Gateway ID
    Value: !Ref ApiGateway
    Export:
      Name: !Sub '${AWS::StackName}-ApiGatewayId'
  
  UserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref UserPool
    Export:
      Name: !Sub '${AWS::StackName}-UserPoolId'
  
  UserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !Ref UserPoolClient
    Export:
      Name: !Sub '${AWS::StackName}-UserPoolClientId'
  
  LambdaFunctionArns:
    Description: Lambda Function ARNs
    Value: !Sub |
      ProductApi: ${ProductApiFunction.Arn}
      CartApi: ${CartApiFunction.Arn}
      OrderApi: ${OrderApiFunction.Arn}
      AuthApi: ${AuthApiFunction.Arn}
      ReviewApi: ${ReviewApiFunction.Arn}
      SearchApi: ${SearchApiFunction.Arn}
      ChatApi: ${ChatApiFunction.Arn}
      AnalyticsApi: ${AnalyticsApiFunction.Arn}

  LambdaAliasArns:
    Description: Lambda Function Alias ARNs with Provisioned Capacity
    Value: !Sub |
      ProductApi-LIVE: ${ProductApiAlias} (2 units)
      CartApi-LIVE: ${CartApiAlias} (2 units)
      OrderApi-LIVE: ${OrderApiAlias} (2 units)
      AuthApi-LIVE: ${AuthApiAlias} (2 units)
      ReviewApi-LIVE: ${ReviewApiAlias} (2 units)
      SearchApi-LIVE: ${SearchApiAlias} (2 units)
      ChatApi-LIVE: ${ChatApiAlias} (2 units)
      AnalyticsApi-LIVE: ${AnalyticsApiAlias} (2 units)